#!/usr/bin/env bash
# bin/compile <build-dir> <cache-dir>

# Fail fast and fail hard.
set -eo pipefail

BUILD_DIR=$1
CACHE_DIR=$2

FIXED_HOME=/app

sudo apt-get install ghc cabal-install

# Set PATH
export PATH=$FIXED_HOME/ghc/bin:$FIXED_HOME/.cabal/bin:$PATH

echo "-----> Updating Cabal"
cabal update
echo "-----> Install latest cabal"
cabal install cabal-install
echo "-----> Release the hounds! Installing application"
cd $BUILD_DIR
cabal install -j5 --disable-library-profiling --disable-executable-profiling --disable-shared

echo "-----> Caching Cabal packages"
echo $FIXED_HOME/.ghc
shopt -s extglob
rm $FIXED_HOME/.cabal/bin/!(cabal|happy)
mv $FIXED_HOME/.cabal $CACHE_DIR/cabal
mv $FIXED_HOME/ghc $CACHE_DIR/ghc
mv $FIXED_HOME/.ghc $CACHE_DIR/dotghc

echo "Cache dir size:"
du -ms $CACHE_DIR
echo "Build dir size:"
du -ms $BUILD_DIR
